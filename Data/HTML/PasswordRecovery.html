<html>
  <head>
    <title>Востановление пароля</title>
  </head>
  <body>
    <form id="PasswordForm" onsubmit="return processPassword(this)" hidden="true" >
        <label id="title0" style="color:green"></label><br>
        <label id="title1" style="color:red"></label><br>
        <label for="password1">Новый пароль:</label>
        <label id="title2" for="password1" style="color:red"></label><br>
        <input type="password" id="password1" name="password" maxlength="20"><br>
        
        <label for="password2">Повторите пароль:</label>
        <label id="title3" for="password2" style="color:red"></label><br>
        <input type="password" id="password2" name="password2" maxlength="20"><br>
        
        <button type="submit">Изменить</button>
    </form>
    <form id="EmailForm" onsubmit="return processEmail(this)" hidden="true" >
        <label id="title00" style="color:green"></label><br>
        <label id="title01" style="color:red"></label><br>
        <label for="login_password">Введите свою почту</label>
        <label id="title02" for="email" style="color:red"></label><br>
        <input type="email" id="email" name="Email"><br>
        
        <button type="submit">Восстановить пароль</button>
    </form>
    <a href="Login.html">Войти</a>
  </body>
  <!-- <script src="Main.js"></script> -->
  <script>
    let code = document.location.search.slice(6)
    if(code.length>2) document.getElementById("PasswordForm").hidden = false;
    else              document.getElementById("EmailForm")   .hidden = false;
    function processEmail(e) {
        let email = e[0].value
        document.getElementById("title02").textContent = (email.length > 0 ? "" : "*Поле пустое!")
        if(email.length < 1) return false;
        console.log("Send letter");
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/send-reset-code");
        xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
        xhr.send(email);
        xhr.onreadystatechange = (ev) => {
            console.log("Status of output: "+ev.target.status)
            console.log(ev.target)
            switch(ev.target.status) {
            case 201:
                document.getElementById("PasswordForm").hidden = true;7
                document.getElementById("title00").textContent = "На указанную почту направлено письмо с ссылкой для изменения пароля."
                break
            case 404:
                document.getElementById("title01").textContent = "Пользователя с такой почтой не найдено!"
                break
            }
        }

        return false;
      }
    function processPassword(e) {
      let password = e[0].value
      let password2 = e[1].value
      document.getElementById("title2").textContent = (password.length > 0 ? "" : "*Поле пустое!")
      document.getElementById("title3").textContent = (password2.length > 0 ? "" : "*Поле пустое!")
      if(password.length < 1)
        return false;
      if(password!=password2) {
        document.getElementById("title1").textContent = "Пароли не совпадают!"
        return false;
      }
      var formData = JSON.stringify({
        ID:code, Password:password
      });
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "/reset-password");
      xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
      xhr.send(formData);
      xhr.onreadystatechange = processing;
      function processing(ev) {
        console.log("Status of output: "+ev.target.status)
        console.log(ev.target)
        document.getElementById("PasswordForm").hidden = true;
        switch(ev.target.status) {
          case 200:
            document.getElementById("title0").innerHTML = "Пароль изменен! <br><a href=\""+document.location.origin + "/Login.html\">Войти</a>"
            // setTimeout(()=>document.location.href = document.location.origin + "/Login.html", 0);
            break
          case 404:
            document.getElementById("title1").innerHTML = "Запрос на создание пароля не найден. <br><a href=\""+document.location.origin + "/PasswordRecovery.html\">Отправить письмо для изменения пароля</a>"
            break
          case 500:
            document.getElementById("title1").innerHTML = "Ошибка при изменении пароля. <br><a href=\""+document.location.origin + "/Login.html\">Войти</a>"
            break
        }
      }

      return false;
    }
  </script>
</html>